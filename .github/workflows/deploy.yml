name: Deploy to Tencent Cloud

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          envs: VITE_SUPABASE_URL,VITE_SUPABASE_ANON_KEY
          script: |
            cd /var/www/ELC
            git pull origin main

            # Debug: Check if env vars are passed
            echo "Checking env vars..."
            echo "VITE_SUPABASE_URL length: ${#VITE_SUPABASE_URL}"
            echo "VITE_SUPABASE_ANON_KEY length: ${#VITE_SUPABASE_ANON_KEY}"

            # Create .env file from secrets (using echo for reliability)
            echo "VITE_SUPABASE_URL=${VITE_SUPABASE_URL}" > .env
            echo "VITE_SUPABASE_ANON_KEY=${VITE_SUPABASE_ANON_KEY}" >> .env

            # Verify .env was created
            echo "Created .env with $(wc -l < .env) lines"

            npm install
            npm run build
            echo "Deploy completed at $(date)"
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
